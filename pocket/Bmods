#!/bin/zsh
#
# FileName:     Bmods
# Author:       8ucchiman
# CreatedDate:  2023-07-27 13:10:49
# LastModified: 2023-01-23 14:11:45 +0900
# Reference:    https://unix.stackexchange.com/questions/33255/how-to-define-and-load-your-own-shell-function-in-zsh
#               https://sig9.org/archives/1120
# Description:  ---
#


function _check_file_exist () {
    # https://tanakatarou.tech/1699/
    [ -e $1 ]; echo $?; # or [ -a file ];
}

function _has () {
    return $( whence $1 &>/dev/null )
}

function ls_all_files () {
    #
    # @Description  ls all files with recursively directories
    # @params       $1: target directory
    #
    # @Example      $ Bmods ls_all_files $HOME/bin/gulliver
    #               > 
    #               >
    #               >
    #               >
    ls -l --color=auto -d `find $1`
    # ls -ld --color=auto $(find $HOME/bin/gulliver)
    # ls -ld --color=auto `find $HOME/bin/gulliver`
}


function background_one_foreground_the_other () {
    #
    # @Description  command a & command b
    #               background command a
    #               foreground command b
    # @params       $1: command a
    #               $2: command b
    # @Example
    # @Reference    https://qiita.com/egawa_kun/items/714394609eef6be8e0bf
    #
    $1 & $2
}

function order_concat_commands () {
    #
    # @Description  command a && command b
    #               run command a, if error, next command b is not running
    #               command b
    # @params       $1: command a
    #               $2: command b
    # @Example
    # @Reference    https://qiita.com/egawa_kun/items/714394609eef6be8e0bf
    #
    $1 && $2
}

function reorder_concat_commands () {
    #
    # @Description  command a || command b
    #               background command a
    #               foreground command b
    # @params       : command a
    #               : command b
    # @Example
    # @Reference    https://qiita.com/egawa_kun/items/714394609eef6be8e0bf
    #
    $1 || $2
}


function update_check () {
    
}


function install_fzf () {
    #
    # @Description  install 
    #
    #
    #
    git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
    ~/.fzf/install
}

function install_bat () {
}

function array_fzf () {
    #
    # $1: array
    # $2: preview
    #
    local array=($(echo $1))
    echo $(printf '%s\n' "${array[@]}" | fzf --preview="$2" --preview-label='' --height 100% )
}

function file_fzf () {
    #
    # $1: file
    #
    echo $(cat $1 | fzf --height 100% )
}

function ls_fzf () {
    #
    # $1: any path
    #
    echo $(ls -1 $1 | fzf --height 100%)
}

function function_lst () {
    file=$1
    #
    # awk pattern with variable
    # Reference: https://stackoverflow.com/questions/39384283/how-to-match-a-pattern-given-in-a-variable-in-awk
    #            https://www.rasukarusan.com/entry/2019/04/30/000000
    #
    function_lst=($(awk -v pattern=$2 '$0 ~ pattern' $file))
}

function func_lst() {
    #
    #
    # Reference: https://www.rasukarusan.com/entry/2019/04/30/000000
    #

    local func=$(
       typeset -f \
       | grep ".*() {$" \
       | grep "^[a-z_]" \
       | tr -d "() {"   \
       | fzf --height 100% --preview "source ~/Bmods; typeset -f  {}"
   )
    if [ -z "$func" ]; then
        return
    fi
    typeset -f $func
}

function Bmods_function_lst () {
    #
    #
    #
    local function_lst=($(awk '/^function/{print $2}' $HOME/Bmods))
    #local target_function=`array_fzf "${function_lst[*]}" "cat $HOME/"`
    local target_function=`printf '%s\n' "${function_lst[@]}" | fzf --preview-label="howto" --preview='grep -A 6 {} $HOME/Bmods' --height 100%`
    eval "${target_function}"
}


typeset -a MODULE_lst
typeset -A SUBMODULES
typeset -A MYWORK_lst
function set_variables () {
    #
    #
    #
    #
    echo "******************************"
    echo "* set_variables              *"
    echo "******************************"
    BASE_DIR=$PWD
    DOTFILES=$HOME/git/dotfiles
    TMP=/tmp/8ucchiman/
    # Reference: https://qiita.com/ttakuya50/items/085bea9176006016e593
    MODULE_lst=(
        _debug
        fuzzy_settings
        default
        show_cmd_history
        load_local
        specific_scripts_function_lst
    )
    #MODULE_lst = make_function_lst $HOME/gmods function zsh
    DOTFILES_SUBMODULES=(
        onelines            .config/lib/onelines
        csharp              .config/lib/codes/csharp
        c                   .config/lib/codes/c
        cpp                 .config/lib/codes/c++
        rust                .config/lib/codes/rust
        python              .config/lib/codes/python
        assembler           .config/lib/codes/assembler
        lua                 .config/lib/codes/lua
        cuda                .config/lib/codes/cuda
        IoT                 .config/lib/codes/IoT
        shell               .config/lib/codes/shell
    )
    # MYWORK_lst=(
    #     slam                # path
    #     maestro             # path
    #     speedestimation     # path
    # )
}


function setup_environment () {
    ln -sf $HOME/dotfiles/.config/pockets/shell/Bmods Bmods
}

function _debug () {
    #
    # Check Bmods path!!!
    #
    echo "8ucchiman was here!!"
}


function add_submodules () {
    #
    # TL;DR:    Add submodules
    # Arguments: 
    #       $1: url
    #

    git submodule add $1
}

function show_samples () {
    #
    # Show sample images
    #
    local sample=`ls_fzf $HOME/.config/sample`
    open $sample
    # echo $sample
}


function show_cmd_history () {
    #
    # TL;DR:        Show .zhistory
    #
    #
    file_fzf $HOME/.zhistory
}

function run_submodule () {
    #
    # toDo!!!!!!!!! my work
    #
    local target_submodule=`ls_fzf `
}


function run_python () {
    #
    # toDo!!!!!!!!! my work
    #
    #
   
}

function run_c () {
    #
    # toDo!!!!!!!!! my work
    #
    #
   
}

function run_cpp () {
    #
    # toDo!!!!!!!!! my work
    #
    #

}

function run_rust () {
    #
    # toDo!!!!!!!!! my work
    #
    #

}

function run_csharp () {
    #
    # toDo!!!!!!!!! my work
    #
    #

}

function run_csharp () {
    #
    # toDo!!!!!!!!! my work
    #
    #

}

function update_dotfiles () {
    #
    # TL;DR: update dotfiles
    #
    #
    cd $DOTFILES
    git fetch origin dev
    git merge origin/dev
    for value in ${(v)DOTFILES_SUBMODULES}; do
        cd $DOTFILES/$value
        git fetch origin dev
        git merge origin/dev
    done
    source $HOME/.zshrc
}


function _load_mywork_submodules () {
    
}



function fuzzy_settings () {
    #---------------#
    #   fzf & ag    #
    #---------------#
    # fzf から the_silver_searcher (ag) を呼び出すことで高速化
    # fzf の キーバインド
    #if [ -e /opt/local/share/fzf/shell/key-bindings.zsh ]; then
    #    source /opt/local/share/fzf/shell/key-bindings.zsh
    #fi
    
    if [ -e $HOME/.fzf/shell/completion.zsh ]; then
        source $HOME/.fzf/shell/completion.zsh
    fi
    
    # fzf の 補完設定
    #if [ -e /opt/local/share/fzf/shell/completion.zsh ]; then
    #    source /opt/local/share/fzf/shell/completion.zsh
    #fi
    
    if _has fzf && _has ag; then
        export FZF_DEFAULT_COMMAND='ag --nocolor -g ""'
        export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
        export FZF_ALT_C_COMMAND="$FZF_DEFAULT_COMMAND"
        export FZF_COMMON_MYOPTS="--height 40% --layout=reverse --multi"
        export FZF_DEFAULT_OPTS="$FZF_COMMON_MYOPTS" # --preview 'bat --color=always {} --style=plain'"
        export FZF_CTRL_T_OPTS="$FZF_COMMON_MYOPTS" # --bind 'ctrl-y:execute-silent(echo {} | pbcopy)+abort' --border --preview 'bat --color=always {}'"
    fi

}

function load_local () {
    #
    # TL;DR:        load local a file.zsh
    #
    #
    yn=`check_file_exist $1`
    if [[ $yn == "y" ]]; then
        source $1
    else
        echo "not exist local file"
    fi
}

function font_settings () {
    #
    # show config?
    #     $ cat /etc/fonts/fonts.conf
    #
    # Reference: https://zenn.dev/hanaasagi/articles/9e428f0c9594a6
    #
    if [[ -e $HOME/.fonts ]]; then

    else
        ln -sf $HOME/dotfiles/.config/fonts $HOME/.fonts
    fi
    fc-cache -f -v
}

function link_all () {
    #
    # Description:  link all files at one time
    # @params $1: pattern
    # @return 
    #
    # Reference:    https://qiita.com/real_yaruo/items/0a1b4a88cfd5f27f062d
    #
    ls *.txt | xargs -I{} ln -s {} link.{}
}

function anaconda () {
}

function clone_testrepository() {
    cd $TEMP
    git clone https://github.com/Bucchiman/test.git
}

function myawk () {
    """
        
    """
}

#function _assert() {
#    #
#    # $1: 条件式
#    # $2: 条件式がFalseの時に出力するメッセージ
#    # Reference: https://qiita.com/nannoki/items/15004992b6bb5637a9cd
#    #
#    eval $1
#    if [[ $? == 0 ]]; then
#        echo "great work!!!"
#    else
#        echo $2
#    fi
#}
#
#function test_add () {
#    _assert "$1"
#}

# function _assert () {
#     expected="$2"
#     input="$3"
# 
# 
#     ./9cc "$input" > tmp.s
#     cc -o tmp tmp.s
#     ./tmp
#     actual="$?"
# 
#     if [[ "$actual" == "$expected" ]]; then
#         echo "$input => $actual"
#     else
#         echo "$input => $expected expected, but got $actual"
#         exit 1
#     fi
# }

#assert 0 0
#assert 42 42

#echo OK



function default () {
    #
    # this is default setting
    # you can run this function without no arguments.
    #
    echo "******************************"
    echo "* default                    *"
    echo "******************************"
    echo "this is default setting"
    echo "you can run this function without no arguments."
}


function search () {
    local load_readme=$(cd $HOME/.config/lib/readme; /usr/bin/find . -type f | fzf --height 100% )
}



#######################################
function main01 () {
    set_variables
    fuzzy_settings
    if [[ $@ == "" ]]; then
        # array_of_lines=("${(@f)$(my_command)}")
        # Reference: https://unix.stackexchange.com/questions/29724/how-to-properly-collect-an-array-of-lines-in-zsh
        # Reference: https://stackoverflow.com/questions/15691942/print-array-elements-on-separate-lines-in-bash
        # printf '%s\n' "${my_array[@]}"
        local target_func=`Bmods_function_lst`
        echo $target_func
        # eval ${target_func}
    else
        eval $@
    fi
}

ME=Bmods
main01 $@
#######################################


return
